{% extends "baseControl.html" %}
{% load static %}
<!--Css del template-->
{% block css %}

{% endblock %}
<!--Titulo-->
{% block titulo %} Bitacora{% endblock %}
{% block content %}
<div class="container py-2 rounded">
    <div class="row g-0">
        <h2 class="fw-bold text-secondary">Bitacora Mensula de Examenes</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb pt-3">
                <li class="breadcrumb-item"><a href="{% url 'inicio_lab' %}">Laboratorio Clinico</a></li>
                <li class="breadcrumb-item active" aria-current="page">Bitacora Mensual</li>
            </ol>
        </nav>
    </div>    
</div>

<div class="container">
    <div class="row g-0">
    
      <!--NavegaciÃ³n Entre Consultas y Examenes de Laboratorio-->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        {% if rol == ROL_LIC_LABORATORIO %}
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#consultaMedica" type="button" role="tab" aria-controls="home" aria-selected="true">Examenes de Laboratorio</button>  
        </li>
        {% elif rol == ROL_SECRETARIA  %}
        <li class="nav-item" role="presentation">
          <a class="nav-link" href="{% url 'sala_consulta' %}" id="profile-tab" >Consulta Medica</a>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#consultaMedica" type="button" role="tab" aria-controls="home" aria-selected="true">Examenes de Laboratorio</button>  
        </li>
        {% endif %}
      </ul>
      <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="consultaMedica" role="tabpanel" aria-labelledby="home-tab">
          <!--Tabla de pacientes en cola-->
          <div class="table-responsive">
            <table class="table table-bordered text-center bg-white">
                <thead class="table-secondary">
                  <tr>
                    
                    <th scope="col">Numero Cola</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Apellidos</th>
                    <th scope="col">Sexo</th>
                    <th scope="col">Edad</th>      
                    <th scope="col">Examen</th>            
                    <th scope="col">Fase</th>                                        
                    <th scope="col">Fecha</th>    
                    <th scope="col">Consumo</th>
                    <th scope="col">Estado</th> 
                    {% if rol == ROL_LIC_LABORATORIO %}               
                    <th scope="col">Ver<br/>Resultados</th>
                    {% endif %}
                  </tr>
                </thead>
                <tbody id="tabla_cola">
                </tbody>
            </table>
          </div>
          <div class="text-center">
            <div class="spinner-border text-primary" role="status" id="load">
                <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">...</div>
      </div>

    </div>   
</div>
{% endblock %}
<!--Js de la vista-->
{% block js %}
<script src="{% static 'js/laboratorioBusqueda.js' %}"></script>
<script>
$( "#side_bitacora" ).addClass( "active" );
const url = "{% url 'autocompletado_apellidos' %}";
const urlFiltro = "{% url 'busqueda_paciente' %}";
const complementoConsulta = "?apellido_paciente=";
const id_component="id_apellido_paciente";
const id_modal="AgregarCola";
const tablaResultado = "datos_pacientes"; //El id de una tabal en la que saldran los resultados
const tablaColaConsulta="tabla_cola";
const tabla_examenes="tabla_cola";
const url_consulta="{% url 'get_contieneConsulta' %}"
let tablaCola=document.getElementById(tablaColaConsulta);
let tablaData=document.getElementById(tablaResultado);
let tabla_examenes_cola=document.getElementById(tabla_examenes);
let tabla_examenes_cola_pendientes=document.getElementById("tabla_cola_pendientes");
let cargando=false;

// al agregar examen de laboratorio a la cola, retorna json para notificar

//Tipo consulta == 0, Examenes del dia, tipo_consulta == 1, Examenes sin finalizar
function get_cola_examenes(tipo_consulta){
  let tabla;
  if (tipo_consulta==1){
    tabla=tabla_examenes_cola_pendientes;
  }
  else{
    tabla=tabla_examenes_cola;
  }
  $.ajax({
  url: url_consulta,
  url: "{% url 'get_cola_examenes' %}",
  type:"GET",
  dataType: "json",data: {
    'tipo_consulta':tipo_consulta.toString()
  },
  success: function(data){ 
    tabla.innerHTML=null; //borrando los datos previos en la cola examenes
    console.log(data)
    $('#load').hide();
    if(data.type=='warning'){
      toastr[data.type](`${data.data}`);
      {% if rol == ROL_LIC_LABORATORIO %}
      tabla.insertAdjacentHTML("beforeend", `<tr colspan="10" ><td colspan="10" style="text-align:center">${data.data}</td></tr>`);
      {% elif rol == ROL_SECRETARIA %}
      tabla.insertAdjacentHTML("beforeend", `<tr colspan="9" ><td colspan="9" style="text-align:center">${data.data}</td></tr>`);
      {% endif %}
    }else{
      data.data.forEach(examenItem => {
      //Recorre los elemntos del objeto
      let elemento='<tr>';
      const nodeFila = document.createElement("tr");
      for (const property in examenItem) {
          /**
           * Si es lic de lab entonces se recive una url que redirige a la elaboracion de resultados, si es secretaria entonces le envia el el id_expediente y el id_resultados
           * ya que la combinacion de estos es la key primary de espera examen
          */
        {% if rol == ROL_LIC_LABORATORIO %}
          if(property!='url_resultado'&& property!='id_resultado' && property!='id_expediente'){
        {% elif rol == ROL_SECRETARIA %}
          if(property!='id_resultado' && property!='id_expediente' && property!='url_resultado_pdf'){
        {% endif %}
          /** 
           * desplegando cada atributo del examen en una columna que luego es agregada a una fila
           * que es agregada a la tabla luego de agregar el boton de cambiar fase o elaborar 
           * resultados de examen
           */
            const nodeColumna = document.createElement("td");
            const textnode = document.createTextNode(`${examenItem[property]}`);
            nodeColumna.appendChild(textnode);
            nodeFila.appendChild(nodeColumna);
            
        }
        
      }
      /**
       * Agregando el boton de cambiar fase o elaborar resultados de examen
      */
      let nodeColumna = document.createElement("td");
    {% if rol == ROL_LIC_LABORATORIO %}
      nodeFila.appendChild(nodeColumna);
   
      nodeColumna.innerHTML=`<a href="${examenItem['url_resultado']}" target="_blank"><div class="material-symbols-outlined btn btn-outline-primary">open_in_new</div></a>`;

    {% elif rol == ROL_SECRETARIA %}
      if(examenItem['fase_examenes_lab']=='Resultados en Proceso'){
        nodeColumna.innerHTML=`<button type="button"
                            class="material-symbols-outlined btn btn-primary" disabled>done</button>`;
      }else if(examenItem['fase_examenes_lab']=='Resultados Listos'){
        nodeColumna.innerHTML=`<a target="_blank"
                            class="material-symbols-outlined btn btn-outline-success"
                            href="${examenItem['url_resultado_pdf']}" >download</a>`;
      }else{
        nodeColumna.innerHTML=`<button type="button"
                            class="material-symbols-outlined btn btn-outline-primary"
                            onclick="cambiar_fase(${examenItem['id_resultado']},${examenItem['id_expediente']})">done</button>`;
      }
      
    {% endif %}
      nodeFila.appendChild(nodeColumna);      
      tabla.appendChild(nodeFila);            
      });
    }}});
}
    
get_cola_examenes(0);

function cambiar_fase(id_resultado,id_expediente) {
  $.ajax({
    url: url_consulta,
    {% if rol == ROL_LIC_LABORATORIO %}
    url: "{% url 'cambiar_fase_laboratorio' %}",
    {% else %}
    url: "{% url 'cambiar_fase_secretaria' %}",
    {% endif %}
    type:"POST",
    dataType: "json",
    headers: {
                  'X-CSRFToken': "{{csrf_token }}"
      }, data: {
        'id_expediente':id_expediente,
        'id_resultado':id_resultado
      },
    success: function(data){ 
      //disable button

      toastr[data.type](`${data.data}`);
      get_cola_examenes(0);
    }
  });
}
function descargar_examen(id_resultado) {
  $.ajax({
    url: url_consulta,
    url: "{% url 'cambiar_fase_secretaria' %}",
    type:"GET",
    dataType: "json",
    data: {
        'id_expediente':id_expediente,
        'id_resultado':id_resultado
      },
    success: function(data){ 
      //disable button

      toastr[data.type](`${data.data}`);
      get_cola_examenes(0);
    }
  });
}



function accionServer(id, accion){
      let url_accion="";
      switch (accion){
        case 2:
          url_accion="/laboratorio/examen/";
          url_agregar_cola=url_accion+id;
          metodo="GET";
          console.log("prueba")
          break;
      }

      $.ajax({
        url: url_consulta,
                url: url_agregar_cola,
                type:metodo,
                dataType: "json",
                data: {
                  
                },
                success: function(data){ 
                  switch(data.accion){
                    case 2:
                      $('#selectExamen').fadeIn(1000).html(data);
                      let selectExamen=document.getElementById('selectExamen');
                      selectExamen.innerHTML=null
                      let elemento=""
                      data.data.map((x)=>{
                        elemento= elemento+'<option value="'+x.id_examen+'">'+x.nombre_examen+'</option>';
                      });
                      selectExamen.insertAdjacentHTML("beforeend", elemento);
                      break;
                  }           
                }
      });

    }
</script>

{% endblock %}