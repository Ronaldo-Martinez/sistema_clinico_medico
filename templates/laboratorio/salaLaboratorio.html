{% extends "baseControl.html" %}
{% load static %}
<!--Css del template-->
{% block css %}

{% endblock %}
<!--Titulo-->
{% block titulo %} Sala de Espera Laboratorio{% endblock %}
{% block content %}
<div class="container py-4">
  
</div>
<div class="container py-2 rounded">
  <div class="row g-0">
    <h1 class="fw-bold text-secondary">Sala de Espera</h1>
    <div class="col-12 col-md-12">
      <!--Busqueda por Apellidos-->
      {% if rol == ROL_SECRETARIA or rol == ROL_DOCTOR %}
      <div class="input-group  py-4">
          <span class="input-group-text bg-white" id="basic-addon1">
            <span class="material-symbols-outlined btn-sm" id="search_voff">face</span>
          </span>
          <input type="text" class="form-control" id="id_apellido_paciente" placeholder="Apellidos" aria-label="Nombres" aria-describedby="basic-addon1">
          {% if rol == ROL_SECRETARIA %}
          <span class="input-group-text bg-white" id="filtro_buscar">
            <span class="material-symbols-outlined btn btn-sm" id="" data-bs-toggle="modal" data-bs-target="#busquedaPacienteModal">search</span>
          </span>
          {% elif rol == ROL_DOCTOR %}
          <input type="date" name="fecha_consulta" id="fecha_consulta" class="form-control" style="max-width: fit-content;">
          <span class="input-group-text bg-white" id="filtro_buscar">
            <span class="material-symbols-outlined btn btn-sm" >search</span>
          </span>
          {% endif %}
      </div>
      {% endif %}
    </div>
    <!--Boton abregar nuevo -->
    {% if rol == ROL_SECRETARIA  %}
    <div class="col-lg-12 pb-3 text-end">
      <div class="text-end">
        <a href="{% url 'crear_expediente'%}" class="btn btn-outline-secondary" id="buscar-nombre" >Abrir Expediente Nuevo</a>
      </div>
    </div>
    {% endif %}
  </div>

</div>
<div class="container">
    <div class="row g-0">
      
      <!--Tarjetas de pacientes-->
           

      <!--NavegaciÃ³n Entre Consultas y Examenes de Laboratorio-->
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#consultaMedica" type="button" role="tab" aria-controls="home" aria-selected="true">Examenes de Laboratorio</button>  
        </li>
      </ul>
      <div class="tab-content " id="myTabContent">
        <div class="tab-pane fade show active" id="consultaMedica" role="tabpanel" aria-labelledby="home-tab">
          <!--Tabla de pacientes en cola-->
          <div class="table-responsive">
            <table class="table table-bordered text-center">
                <thead class="table-secondary">
                  <tr>
                    
                    <th scope="col">Numero Cola</th>
                    <th scope="col">Nombre</th>
                    <th scope="col">Apellidos</th>  
                    <th scope="col">Examen</th>            
                    <th scope="col">Fase</th>                                        
                    <th scope="col">Fecha</th>    
                    <th scope="col">Consumo</th>
                    <th scope="col">Estado</th>                    
                    <th scope="col"></th>
                  </tr>
                </thead>
                <tbody id="tabla_cola">
                  
                </tbody>
            </table>
          </div>
        </div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">...</div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">...</div>
      </div>


      <!--Modal Datos del Paciente-->
      <div class="modal fade" id="busquedaPacienteModal" tabindex="-1" aria-hidden="true" aria-labelledby="modalTitle">
        <div class="modal-dialog modal-xl">
          <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Agregar Paciente a Cola</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <!--Tabla de pacientes buscados-->
                <div class="table-responsive" id="tabla_busqueda">
                  <table class="table table-bordered text-center">
                    <thead class="table-secondary">
                      <tr>
                          <th>ID</th>
                          <th>Nombre</th>
                          <th>Apellidos</th>
                          <th>Fecha Nacimiento</td>
                          <th>Sexo</th>
                          <th>Direccion</th>
                          <th>Email</th>
                          <th>Responsable</th>
                          <th>Agregar Examen</th>
                        </tr>
                    </thead>
                    <tbody  id="datos_pacientes">
                    </tbody>
                  </table>
                </div>
            </div>
            <div class="modal-footer">
            </div>
          </div>
        </div>
      </div>


      <!--Modal seleccionar Examen-->
      <div class="modal" tabindex="-1" id="modalSelectExamen"  aria-hidden="true" aria-labelledby="modalTitle">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Seleccionar Examen</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                  <!--Datos del paciente-->
                  <p class="fw-bold text-secondary">Datos del Paciente</p>
                  <hr class="dropdown-divider">
                  <div class="row">
                    <div class="col-md-12 col-lg-6">
                      <div class="mb-3">
                        <label for="nombrePaciente" class="form-label">Nombre del paciente:</label>
                        <input type="text" class="form-control" id="nombrePaciente" aria-describedby="emailHelp" disabled>
                      </div>
                    </div>
                    <div class="col-md-12 col-lg-6">
                      <div class="mb-3">
                        <label for="edadPaciente" class="form-label">Edad del paciente:</label>
                        <input type="text" class="form-control" id="edadPaciente" aria-describedby="emailHelp" disabled>
                      </div>
                    </div>
                  </div>
                  <input type="text" id="pacienteId" hidden>
                  <!--Datos del Examen-->
                  <p class="fw-bold text-secondary pt-2">Examen a Realizar</p>
                  <hr class="dropdown-divider">
                  <div class="row">
                    <div class="col-md-12 col-lg-6">
                      <div class="mb-3">
                        <label for="selectCategoria" class="form-label">Seleccione el Perfil</label>
                        <select id="selectCategoria" class="form-select">
                          {% for c in Categoria %}
                            <option value="{{ c.id_categoria }}">{{ c.nombre_categoria }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                    <div class="col-md-12 col-lg-6">
                      <div class="mb-3">
                        <label for="selectExamen" class="form-label">Seleccione el Examen</label>
                        <select id="selectExamen" class="form-select">
                          {% for e in Examen %}
                            <option value="{{ e.examen_laboratorio.id_examen_laboratorio }}">{{ e.examen_laboratorio.nombre_examen }}</option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary"
                    onclick="agregarExamen();">Save changes</button>
                </div>
            </div>
        </div>
      </div>
    </div>   
  </div>
{% endblock %}
<!--Js de la vista-->
{% block js %}
<script src="{% static 'js/laboratorioBusqueda.js' %}"></script>
<script>
    const url = "{% url 'autocompletado_apellidos' %}";
    const urlFiltro = "{% url 'busqueda_paciente' %}";
    const complementoConsulta = "?apellido_paciente=";
    const id_component="id_apellido_paciente";
    const id_modal="AgregarCola";
    const tablaResultado = "datos_pacientes"; //El id de una tabal en la que saldran los resultados
    const tablaColaConsulta="tabla_cola";
    const url_consulta="{% url 'get_contieneConsulta' %}"
    let tablaCola=document.getElementById(tablaColaConsulta);
    let tablaData=document.getElementById(tablaResultado);

    function agregarExamen(){
      //recuperacion de datos 
      console.log()
      // let id_examen_laboratorio=parseInt(1)
      let id_examen_laboratorio=$('#selectExamen').val()

      let id_paciente=parseInt(document.getElementById('pacienteId').value);
      $.ajax({
        url: url_consulta,
                url:"{% url 'agregar_examen_cola' %}",
                type:"POST",
                dataType: "json",
                headers: {
                          'X-CSRFToken': "{{csrf_token }}"
                        },
                data: {
                        'id_paciente':id_paciente,
                        'id_examen_laboratorio':id_examen_laboratorio
                      },
                success: function(data){ 
                 console.log(data) 
                }
      });
    }
    


    //Invocando Funciones
    getAutocompletado(url, id_component, tablaResultado, urlFiltro, complementoConsulta, tablaData, id_modal);


    function accionServer(id, accion){
      let url_accion="";

      switch (accion){
        //Si se va agregar a la cola
        case 1:
          url_accion = "/laboratorio/cola/";
          url_agregar_cola=url_accion+id;
          metodo="POST";
          break;
        //  
        case 2:
          url_accion="/laboratorio/get-select-examen/";
          url_agregar_cola=url_accion+id;
          metodo="GET";
          console.log("prueba")
          break;
      }
      //console.log(url_agregar_cola);
      //console.log($('#inputTemperatura').val().toString());

      $.ajax({
        url: url_consulta,
                url: url_agregar_cola,
                type:metodo,
                dataType: "json",
                data: {
                  
                },
                success: function(data){ 
                  switch(data.accion){
                    case 1:
                      consultarCola(url_consulta, tablaCola);
                      toastr[data.type](data.data);
                      break;
                    case 2:
                      $('#selectExamen').fadeIn(1000).html(data);
                      let selectExamen=document.getElementById('selectExamen');
                      selectExamen.innerHTML=null
                      let elemento=""
                      data.data.map((x)=>{
                        elemento= elemento+'<option value="'+x.id_examen+'">'+x.nombre_examen+'</option>';
                      });
                      selectExamen.insertAdjacentHTML("beforeend", elemento);
                      break;
                  }           
                }
      });
      
    }

    //event listeners para buscar pacientes o filtrar consultas
    // {% if rol == ROL_SECRETARIA %}    
    //Para moviles, click en la lupa
/*    
    // {% elif rol == ROL_DOCTOR %}
    // #fecha por defecto
    // document.getElementById('fecha_consulta').valueAsDate = new Date();
    document.getElementById("filtro_buscar").addEventListener("click",function(){
      let apellidos=document.getElementById('id_apellido_paciente').value;
      let fecha=document.getElementById('fecha_consulta').value;
      var targetDate = new Date( fecha );

      if ( !!targetDate.valueOf() ) {
          year = targetDate.getFullYear();
          month = targetDate.getMonth()+1;
          day = targetDate.getDate()+1;
          data={
            'apellido_paciente':apellidos,
            'year': year,
            'month': month,
            'day': day,
            'query':1
          }
        }else{
        data={
          'apellido_paciente':apellidos,
          'query':1
        }

      }
      consultarCola(url_consulta, tablaCola,data)
    });
    // {% endif %}
    
    // {% if rol == ROL_DOCTOR or rol == ROL_SECRETARIA %}
    //Lenar autocompletado
    getAutocompletado(url, id_component, tablaResultado, urlFiltro, complementoConsulta, tablaData, id_modal);
    // {% endif %}
    
    consultarCola(url_consulta, tablaCola);
    
    
    function consultarCola(url_consulta, tablaCola,data={}){
      $.ajax({
                url: url_consulta,
                dataType: "json",
                data: data,
                success: function(data){  
                  let elemento;
                  let icon;
                  let modal="";
                  //limpia la tabla de resultados
                  tablaCola.innerHTML=null;
                  //si no hay resultados muestra un mensaje de que no hay resultados
                  if (data.length==0){
                    elemento='<tr><td colspan="100%">No hay pacientes en espera</td></tr>';
                    tablaCola.insertAdjacentHTML("beforeend", elemento);
                  }else{
                    //llenado de tabla
                    data.map((x)=>{
                    elemento='<tr>';
                    //necesito el id_signos
                    id_consulta=x.id_consulta;
                    delete x.id_consulta;
                    for (const property in x) {
                        elemento = elemento+'<td valign="middle">'+`${x[property]}`+'</td>';
                    }
                    // {% if rol == ROL_ENFERMERA %}
                    icon="monitor_heart";
                    modal="data-bs-toggle='modal' data-bs-target='#agregarSignosVitalesModal'";
                    strfuncion="modificar_btn_editar_signos("+id_consulta+");";
                    click="onclick='"+strfuncion+"';";

                    // {% else %}
                    click="";
                    icon = "more_vert";
                    // {% endif %}
                    // {% if rol == ROL_DOCTOR %}
                    elemento=elemento+`<td>
                      <a role="button"   class="btn btn-outline-primary" href="/expediente/consulta/${id_consulta}">
                      <div class="material-symbols-outlined">edit_note</div>
                      <div>Abrir Consulta</div> 
                      </a></td>`;
                    //{% else %}
                    elemento=elemento+'<td><div class="material-symbols-outlined btn" '+click+' '+modal+' >'+icon+'</div></td>';
                    //{% endif %}
                    elemento=elemento+'</tr>';
        
        //   <input type="button"  value="Agregar a cola para examenes de Lab">
        //   <input type="button"  value="Agregar a cola para pasar Consulta">
        //   <input type="button"  value="Cancelar">
                    
                    tablaCola.insertAdjacentHTML("beforeend", elemento);
                    });
                  }
                }
            });
    }
    //Voy a ocupar la misma funcion para agregar y eliminar.
    
    //Editar signos vitales
    function modificar_btn_editar_signos(id_consulta){
      edit = document.getElementById("guarda_signos_vitales");
      strfuncion="accionServer("+id_consulta+");";

      edit.setAttribute("OnClick", strfuncion);
    }
    setInterval(() => {
      consultarCola(url_consulta, tablaCola);
    }, 60*1000);
*/    
</script>

{% endblock %}